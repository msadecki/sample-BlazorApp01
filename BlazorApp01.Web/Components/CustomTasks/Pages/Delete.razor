@page "/customtasks/delete"
@rendermode InteractiveServer
@using BlazorApp01.Domain.Models
@using BlazorApp01.Features.CQRS.MediatorFacade
@using BlazorApp01.Features.CQRS.Requests.CustomTasks.Commands
@using BlazorApp01.Features.CQRS.Requests.CustomTasks.Queries
@using BlazorApp01.Features.Extensions
@using BlazorApp01.Web.Services
@inject ISenderFacade Sender
@inject NavigationManager NavigationManager
@inject IDateTimeHelper DateTimeHelper

<PageTitle>Delete</PageTitle>

<h1>Delete</h1>

<h3>Are you sure you want to delete this?</h3>
<div>
    <h4>CustomTask</h4>
    <hr />
    @if (isLoading)
    {
        <p><em>Loading...</em></p>
    }
    else if (customTask == null)
    {
        <p class="alert alert-danger">CustomTask not found.</p>
    }
    else
    {
        <dl class="row">
            <dt class="col-sm-2">Description</dt>
            <dd class="col-sm-10">@customTask.Description</dd>

            <dt class="col-sm-2">Status</dt>
            <dd class="col-sm-10">@customTask.Status</dd>

            <dt class="col-sm-2">Created At (Your Time Zone)</dt>
            <dd class="col-sm-10">@DateTimeHelper.ConvertToFormattedUserDateTime(customTask.CreatedAt)</dd>

            <dt class="col-sm-2">Due Date</dt>
            <dd class="col-sm-10">@DateTimeHelper.ConvertToFormattedDate(customTask.DueDate)</dd>

            <dt class="col-sm-2">Completion Date (Your Time Zone)</dt>
            <dd class="col-sm-10">@(DateTimeHelper.ConvertToFormattedUserDateTime(customTask.CompletionDate) ?? "Not completed")</dd>

            <dt class="col-sm-2">Is Active</dt>
            <dd class="col-sm-10">@(customTask.IsActive ? "Yes" : "No")</dd>
        </dl>

        <EditForm Model="customTask" OnValidSubmit="DeleteCustomTask" FormName="delete">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
            <button type="submit" class="btn btn-danger" disabled="@isDeleting">
                @(isDeleting ? "Deleting..." : "Delete")
            </button>
            <span> | </span>
            <a href="/customtasks">Back to List</a>
        </EditForm>
    }
    @if (!isLoading && customTask == null)
    {
        <div>
            <a href="/customtasks">Back to List</a>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery]
    public int CustomTaskId { get; set; }

    private CustomTask? customTask;
    private bool isLoading = true;
    private bool isDeleting = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var query = new GetCustomTaskByIdQuery(CustomTaskId);
        var result = await Sender.SendAsync(query);

        if (result.IsSuccess)
        {
            customTask = result.Value;
        }
        else
        {
            errorMessage = "Failed to load task: " + string.Join(", ", result.MergedErrors());
        }

        isLoading = false;
    }

    private async Task DeleteCustomTask()
    {
        isDeleting = true;
        errorMessage = string.Empty;

        try
        {
            var command = new DeleteCustomTaskCommand(CustomTaskId);
            var result = await Sender.SendAsync(command);

            if (result.IsSuccess && result.Value)
            {
                NavigationManager.NavigateTo("/customtasks");
            }
            else
            {
                errorMessage = "Failed to delete custom task. It may have already been deleted.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }
}
