@page "/customtasks/create"
@rendermode InteractiveServer
@using BlazorApp01.Features.CQRS.MediatorFacade
@using BlazorApp01.Features.CQRS.Requests.CustomTasks.Commands
@using BlazorApp01.Domain.Enums
@using Ardalis.Result
@inject ISenderFacade Sender
@inject NavigationManager NavigationManager

<PageTitle>Create Custom Task</PageTitle>

<h3>Create New Task</h3>

<EditForm Model="@formModel" OnValidSubmit="HandleSubmit">
    @if (validationErrors.Count > 0)
    {
        <div class="alert alert-danger">
            <h5>Validation Errors:</h5>
            <ul>
                @foreach (var error in validationErrors)
                {
                    <li><strong>@error.Identifier:</strong> @error.ErrorMessage</li>
                }
            </ul>
        </div>
    }

    <div class="mb-3">
        <label class="form-label">Description</label>
        <InputText @bind-Value="formModel.Description" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Status</label>
        <InputSelect @bind-Value="formModel.Status" class="form-control">
            @foreach (var status in Enum.GetValues<CustomTaskStatus>())
            {
                <option value="@status">@status</option>
            }
        </InputSelect>
    </div>

    <div class="mb-3">
        <label class="form-label">Due Date</label>
        <InputDate @bind-Value="formModel.DueDate" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Is Active</label>
        <InputCheckbox @bind-Value="formModel.IsActive" class="form-check-input" />
    </div>

    <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
        @(isSubmitting ? "Creating..." : "Create")
    </button>
    <a href="/customtasks" class="btn btn-secondary">Cancel</a>
</EditForm>

@code {
    private CreateCustomTaskFormModel formModel = new()
    {
        Description = string.Empty,
        Status = CustomTaskStatus.Pending,
        DueDate = DateOnly.FromDateTime(DateTime.Today.AddDays(7)),
        IsActive = true
    };

    private bool isSubmitting;
    private List<ValidationError> validationErrors = new();

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        validationErrors.Clear();

        // Map form model to command (immutable record)
        var command = new CreateCustomTaskCommand(
            Description: formModel.Description,
            Status: formModel.Status,
            CreatedAt: DateTime.UtcNow,
            DueDate: formModel.DueDate,
            CompletionDate: formModel.Status == CustomTaskStatus.Completed ? DateTime.UtcNow : null,
            IsActive: formModel.IsActive
        );

        var result = await Sender.SendAsync(command);

        if (result.IsSuccess)
        {
            NavigationManager.NavigateTo("/customtasks");
        }
        else if (result.Status == ResultStatus.Invalid)
        {
            // Validation errors are automatically captured by ValidationBehavior
            validationErrors = result.ValidationErrors.ToList();
        }
        else
        {
            validationErrors.Add(new ValidationError(
                identifier: "General",
                errorMessage: string.Join(", ", result.Errors),
                errorCode: string.Empty,
                severity: ValidationSeverity.Error));
        }

        isSubmitting = false;
    }

    // Mutable form model for Blazor data binding
    private sealed class CreateCustomTaskFormModel
    {
        public string Description { get; set; } = string.Empty;
        public CustomTaskStatus Status { get; set; }
        public DateOnly DueDate { get; set; }
        public bool IsActive { get; set; }
    }
}
