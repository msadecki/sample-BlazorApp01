@page "/weather"
@using Microsoft.AspNetCore.Components.QuickGrid
@using BlazorApp01.Web.Services
@using System.Globalization
@inject IDateTimeHelper DateTimeHelper
@inject IWeatherService WeatherService
@rendermode InteractiveServer

<PageTitle>Weather</PageTitle>

<h1>Weather</h1>

<p>This component demonstrates showing data with user time zone conversion. It uses free weather forecast API data feed (open-meteo.com).</p>

@if (forecasts == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <QuickGrid Class="table" Items="@forecasts.AsQueryable()">
        <PropertyColumn Property="@(forecast => forecast.DateAtUserTZ)" Title="Date (User TZ)" Sortable="true" />
        @* <PropertyColumn Property="@(forecast => forecast.DateTimeAtUserTZ)" Title="Date Time (User TZ)" Sortable="true" /> *@
        <PropertyColumn Property="@(forecast => forecast.SunriseAtUserTZ)" Title="Sunrise (User TZ)" Sortable="true" />
        <PropertyColumn Property="@(forecast => forecast.SunsetAtUserTZ)" Title="Sunset (User TZ)" Sortable="true" />
        @* <PropertyColumn Property="@(forecast => forecast.CreatedAtUserTZ)" Title="Created (User TZ)" Sortable="true" /> *@
        <PropertyColumn Property="@(forecast => forecast.TemperatureMin)" Title="Temp. Min (C)" Sortable="true" Format="F1" />
        <PropertyColumn Property="@(forecast => forecast.TemperatureMax)" Title="Temp. Max (C)" Sortable="true" Format="F1" />
        @* <PropertyColumn Property="@(forecast => forecast.TemperatureC)" Title="Temp. (C)" Sortable="true" /> *@
        @* <PropertyColumn Property="@(forecast => forecast.TemperatureF)" Title="Temp. (F)" Sortable="true" /> *@
        <PropertyColumn Property="@(forecast => forecast.PrecipitationSum)" Title="Precip. (mm)" Sortable="true" Format="F1" />
        <PropertyColumn Property="@(forecast => forecast.PrecipitationProbabilityMax)" Title="Precip. Prob (%)" Sortable="true" />
        <PropertyColumn Property="@(forecast => forecast.WindSpeedMax)" Title="Wind Max (m/s)" Sortable="true" Format="F1" />
        <PropertyColumn Property="@(forecast => forecast.WeatherCode)" Title="Weather Code" Sortable="true" />
    </QuickGrid>
}

<div class="location-selector" style="margin-top:1rem">
    <h3>Location</h3>
    <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap">
        <label>Latitude:
            <input type="number" step="0.000001" @bind="latitude" />
        </label>
        <label>Longitude:
            <input type="number" step="0.000001" @bind="longitude" />
        </label>
        <button class="btn btn-primary" @onclick="LoadForecastsAsync">Get Forecast</button>
    </div>

    <div style="margin-top:0.5rem">
        <iframe title="map" width="100%" height="300" frameborder="0"
                src="@MapEmbedUrl"
                style="border:1px solid #ccc"></iframe>
    </div>
</div>

@code {
    private WeatherForecast[]? forecasts;
    private double latitude = 52.23224240174998;
    private double longitude = 20.93381175935411;

    private string MapEmbedUrl => GetMapEmbedUrl(latitude, longitude);

    protected override async Task OnInitializedAsync()
    {
        await LoadForecastsAsync();
    }

    private async Task LoadForecastsAsync()
    {
        // Load real data from the weather service using currently selected location
        var points = await WeatherService.GetForecastsAsync(days: 14, latitude: latitude, longitude: longitude);
        forecasts = points.Select(point => new WeatherForecast(DateTimeHelper)
        {
            DateTimeUtc = point.DateTime,
            TemperatureMin = point.TemperatureMin,
            TemperatureMax = point.TemperatureMax,
            TemperatureC = point.TemperatureC,
            PrecipitationSum = point.PrecipitationSum,
            PrecipitationProbabilityMax = point.PrecipitationProbabilityMax,
            WindSpeedMax = point.WindSpeedMax,
            WeatherCode = point.WeatherCode,
            SunriseUtc = point.Sunrise,
            SunsetUtc = point.Sunset,
            CreatedAtUtc = point.CreatedAtUtc
        }).ToArray();

        // Update map (property reflects updated coords)
        StateHasChanged();
    }

    private static string GetMapEmbedUrl(double lat, double lon)
    {
        // Build a simple OpenStreetMap embed URL with a small bbox around the marker
        var latMin = lat - 0.02;
        var lonMin = lon - 0.02;
        var latMax = lat + 0.02;
        var lonMax = lon + 0.02;
        // Example: https://www.openstreetmap.org/export/embed.html?bbox=left,bottom,right,top&layer=mapnik&marker=lat,lon
        return $"https://www.openstreetmap.org/export/embed.html?bbox={lonMin.ToString(CultureInfo.InvariantCulture)},{latMin.ToString(CultureInfo.InvariantCulture)},{lonMax.ToString(CultureInfo.InvariantCulture)},{latMax.ToString(CultureInfo.InvariantCulture)}&layer=mapnik&marker={lat.ToString(CultureInfo.InvariantCulture)},{lon.ToString(CultureInfo.InvariantCulture)}";
    }

        private sealed class WeatherForecast(IDateTimeHelper dateTimeHelper)
        {
            public required DateTime DateTimeUtc { get; init; }
            public required decimal TemperatureMin { get; init; }
            public required decimal TemperatureMax { get; init; }
            public required int TemperatureC { get; init; }
            public required decimal PrecipitationSum { get; init; }
            public required int PrecipitationProbabilityMax { get; init; }
            public required decimal WindSpeedMax { get; init; }
            public required int WeatherCode { get; init; }
            public required DateTime? SunriseUtc { get; init; }
            public required DateTime? SunsetUtc { get; init; }
            public required DateTime CreatedAtUtc { get; init; }

            public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);
            public string DateTimeAtUserTZ => dateTimeHelper.ConvertToFormattedUserDateTime(DateTimeUtc);
            public string DateAtUserTZ => dateTimeHelper.ConvertToFormattedUserDate(DateTimeUtc);
            public string SunriseAtUserTZ => dateTimeHelper.ConvertToFormattedUserDateTime(SunriseUtc);
            public string SunsetAtUserTZ => dateTimeHelper.ConvertToFormattedUserDateTime(SunsetUtc);
            public string CreatedAtUserTZ => dateTimeHelper.ConvertToFormattedUserDateTime(CreatedAtUtc);
        }
}
