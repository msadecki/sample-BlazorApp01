@page "/weather"
@using Microsoft.AspNetCore.Components.QuickGrid
@using BlazorApp01.Web.Services
@inject IDateTimeHelper DateTimeHelper
@inject IWeatherService WeatherService
@rendermode InteractiveServer

<PageTitle>Weather</PageTitle>

<h1>Weather</h1>

<p>This component demonstrates showing data with user time zone conversion. It uses free weather forecast API data feed (open-meteo.com).</p>

@if (forecasts == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <QuickGrid Class="table" Items="@forecasts.AsQueryable()">
        <PropertyColumn Property="@(forecast => forecast.DateAtUserTZ)" Title="Date (User TZ)" Sortable="true" />
        @* <PropertyColumn Property="@(forecast => forecast.DateTimeAtUserTZ)" Title="Date Time (User TZ)" Sortable="true" /> *@
        <PropertyColumn Property="@(forecast => forecast.SunriseAtUserTZ)" Title="Sunrise (User TZ)" Sortable="true" />
        <PropertyColumn Property="@(forecast => forecast.SunsetAtUserTZ)" Title="Sunset (User TZ)" Sortable="true" />
        @* <PropertyColumn Property="@(forecast => forecast.CreatedAtUserTZ)" Title="Created (User TZ)" Sortable="true" /> *@
        <PropertyColumn Property="@(forecast => forecast.TemperatureMin)" Title="Temp. Min (C)" Sortable="true" Format="F1" />
        <PropertyColumn Property="@(forecast => forecast.TemperatureMax)" Title="Temp. Max (C)" Sortable="true" Format="F1" />
        @* <PropertyColumn Property="@(forecast => forecast.TemperatureC)" Title="Temp. (C)" Sortable="true" /> *@
        @* <PropertyColumn Property="@(forecast => forecast.TemperatureF)" Title="Temp. (F)" Sortable="true" /> *@
        <PropertyColumn Property="@(forecast => forecast.PrecipitationSum)" Title="Precip. (mm)" Sortable="true" Format="F1" />
        <PropertyColumn Property="@(forecast => forecast.PrecipitationProbabilityMax)" Title="Precip. Prob (%)" Sortable="true" />
        <PropertyColumn Property="@(forecast => forecast.WindSpeedMax)" Title="Wind Max (m/s)" Sortable="true" Format="F1" />
        <PropertyColumn Property="@(forecast => forecast.WeatherCode)" Title="Weather Code" Sortable="true" />
    </QuickGrid>
}

@code {
    private WeatherForecast[]? forecasts;

    protected override async Task OnInitializedAsync()
    {
        // Load real data from the weather service
        var points = await WeatherService.GetForecastsAsync(days: 14);
        forecasts = points.Select(point => new WeatherForecast(DateTimeHelper)
        {
            DateTimeUtc = point.DateTime,
            TemperatureMin = point.TemperatureMin,
            TemperatureMax = point.TemperatureMax,
            TemperatureC = point.TemperatureC,
            PrecipitationSum = point.PrecipitationSum,
            PrecipitationProbabilityMax = point.PrecipitationProbabilityMax,
            WindSpeedMax = point.WindSpeedMax,
            WeatherCode = point.WeatherCode,
            SunriseUtc = point.Sunrise,
            SunsetUtc = point.Sunset,
            CreatedAtUtc = point.CreatedAtUtc
        }).ToArray();
    }

        private sealed class WeatherForecast(IDateTimeHelper dateTimeHelper)
        {
            public required DateTime DateTimeUtc { get; init; }
            public required decimal TemperatureMin { get; init; }
            public required decimal TemperatureMax { get; init; }
            public required int TemperatureC { get; init; }
            public required decimal PrecipitationSum { get; init; }
            public required int PrecipitationProbabilityMax { get; init; }
            public required decimal WindSpeedMax { get; init; }
            public required int WeatherCode { get; init; }
            public required DateTime? SunriseUtc { get; init; }
            public required DateTime? SunsetUtc { get; init; }
            public required DateTime CreatedAtUtc { get; init; }

            public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);
            public string DateTimeAtUserTZ => dateTimeHelper.ConvertToFormattedUserDateTime(DateTimeUtc);
            public string DateAtUserTZ => dateTimeHelper.ConvertToFormattedUserDate(DateTimeUtc);
            public string SunriseAtUserTZ => dateTimeHelper.ConvertToFormattedUserDateTime(SunriseUtc);
            public string SunsetAtUserTZ => dateTimeHelper.ConvertToFormattedUserDateTime(SunsetUtc);
            public string CreatedAtUserTZ => dateTimeHelper.ConvertToFormattedUserDateTime(CreatedAtUtc);
        }
}
