@rendermode InteractiveServer
@using BlazorApp01.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject ThemeService ThemeService
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IAsyncDisposable

@if (_isAuthenticated)
{
    <div class="theme-toggle">
        <button @onclick="ToggleTheme" class="btn btn-link theme-toggle-btn" title="@GetThemeTitle()">
            @if (_currentTheme == "dark")
            {
                <span>🌙</span>
            }
            else if (_currentTheme == "light")
            {
                <span>☀️</span>
            }
            else
            {
                <span>🌓</span>
            }
        </button>
    </div>
}

@code {
    private string _currentTheme = "auto";
    private bool _hasRendered = false;
    private bool _isAuthenticated = false;
    private bool _isDisposed = false;
    private IJSObjectReference? _themeModule;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _isAuthenticated && !_isDisposed)
        {
            try
            {
                _themeModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/theme.js");
                _currentTheme = await _themeModule.InvokeAsync<string>("getTheme");
                
                ThemeService.SetTheme(_currentTheme);
                await _themeModule.InvokeVoidAsync("setTheme", _currentTheme);
                
                _hasRendered = true;
                StateHasChanged();
            }
            catch (Exception)
            {
                // Silently handle initialization errors
            }
        }
    }

    private async Task ToggleTheme()
    {
        if (!_hasRendered || _themeModule is null || _isDisposed)
        {
            return;
        }

        try
        {
            _currentTheme = _currentTheme switch
            {
                "light" => "dark",
                "dark" => "auto",
                _ => "light"
            };

            ThemeService.SetTheme(_currentTheme);
            await _themeModule.InvokeVoidAsync("saveTheme", _currentTheme);
            await _themeModule.InvokeVoidAsync("setTheme", _currentTheme);
            
            StateHasChanged();
        }
        catch (Exception)
        {
            // Silently handle toggle errors
        }
    }

    private string GetThemeTitle()
    {
        return _currentTheme switch
        {
            "dark" => "Switch to Auto theme",
            "light" => "Switch to Dark theme",
            _ => "Switch to Light theme"
        };
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_isDisposed)
        {
            return;
        }
        
        _isDisposed = true;
        
        if (_themeModule is not null)
        {
            try
            {
                await _themeModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit already disconnected, ignore
            }
            catch (ObjectDisposedException)
            {
                // Already disposed, ignore
            }
            catch
            {
                // Ignore all other disposal errors
            }
        }
    }
}